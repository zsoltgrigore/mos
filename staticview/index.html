<!DOCTYPE html>
<html>
	<head>
		<title>Mesh Data Systems - Chat</title>
		<link rel="stylesheet" href="css/chat.css" type="text/css" />
		<script type="text/javascript" src="js/jquery.min.js"></script>	
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">
		<script type="text/javascript" charset="utf-8">
		// socket.io specific code
	    var socket = io.connect();
	
	    socket.on('connect', function () {
	      $('#chat').addClass('connected');
	    });
	
	    socket.on('announcement', function (msg) {
	      $('#lines').append($('<p>').append($('<em>').text(msg)));
	    });
	
	    socket.on('nicknames', function (nicknames) {
	      $('#nicknames').empty().append($('<span>Online: </span>'));
	      for (var i in nicknames) {
	        $('#nicknames').append($('<b>').text(nicknames[i]));
	      }
	    });
		
		socket.on('mcp message', mcpmessage);
	    socket.on('user message', message);
	    socket.on('reconnect', function () {
	      $('#lines').remove();
	      message('System', 'Reconnected to the server');
	    });
	
	    socket.on('reconnecting', function () {
	      message('System', 'Attempting to re-connect to the server');
	    });
	
	    socket.on('error', function (e) {
	      message('System', e ? e : 'A unknown error occurred');
	    });
	
	    function message (from, msg) {
	      $('#lines').append($('<p>').append($('<b>').text(from), msg));
	    }
	    
	    function mcpmessage (from ,msg) {
	      $('#mcp-lines').append($('<p>').append($('<b>').text(from), msg));
	    }
	
	    // dom manipulation
	    $(function () {
	      $('#set-nickname').submit(function (ev) {
	        socket.emit('nickname', $('#nick').val(), function (set) {
	          if (!set) {
	            clear();
	            return $('#chat').addClass('nickname-set');
	          }
	          $('#nickname-err').css('visibility', 'visible');
	        });
	        return false;
	      });
	      
	      $('#send-message').submit(function () {
	        message('me', $('#message').val());
	        socket.emit('user message', $('#message').val());
	        clear();
	        $('#lines').get(0).scrollTop = 10000000;
	        return false;
	      });
	      
	      $('#send-mcp-message').submit(function () {
	        mcpmessage('me2MCP', $('#mcp-message').val());
	        socket.emit('mcp message', $('#mcp-message').val());
	        clearmcp();
	        $('#mcp-lines').get(0).scrollTop = 10000000;
	        return false;
	      });
	      
	      function clearmcp () {
	        $('#mcp-message').val('').focus();
	      };
	      
	      function clear () {
	        $('#message').val('').focus();
	      };
	    });
		</script>
	</head>
	<body>
		<div id="chat">
			<div id="nickname">
				<form class="wrap" id="set-nickname">
					<p>Please type in your nickname and press enter.</p>
					<input id="nick" type="text" />
					<p id="nickname-err">Nickname already in use</p>
				</form>
			</div>
			<div id="connecting">
				<div class="wrap">Connecting to socket.io server</div>
			</div>
			<div id="messages">
				<div id="nicknames"></div>
				<div id="lines"></div>
			</div>
			<form id="send-message">
				<input id="message" type="text" />
				<button>Send</button>
			</form>
			<h3>Send messages to ESB:</h3>
			<form id="send-mcp-message">
				<input id="mcp-message" type="text" />
				<button>Send</button>
			</form>
			<div id="mcp-messages">
				<div id="mcp-lines"></div>
			</div>
		</div>
	</body>
</html>