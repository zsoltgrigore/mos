<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tester</title>
    <script language="javascript" type="text/javascript" src="js/jquery.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/jquery.flot.js"></script>
	<script language="javascript" type="text/javascript" src="js/json_parse.js"></script>
	<script language="javascript" type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" charset="utf-8">
	var socket = io.connect();
	var msgsent = 0;
	var msgreceived = 0;
	
	var source = "";
	var destination = "agv1.miskolc@dev.gammadigital.hu";
	var sendmsgEnabled = false;
	
	
	//agv_get_xy_req üzenetet reprezentáló osztály
	function agv_get_xy_req() {
		this.header = {
			protocol :"mcp5",
            name : "agv_get_xy_req",
            source : "",
            destination : "",
            session_id : "",
            security_id :""
		};
		this.data = {};
	}
	
	function agv_get_status_req() {
		this.header = {
			protocol :"mcp5",
            name : "agv_get_status_req",
            source : "",
            destination : "",
            session_id : "",
            security_id :""
		};
		this.data = {};
	}
	
	socket.on('connect', function () {
		
	});
	
	socket.on('succesfull login', function (msg) {
		source = msg.header.destination;
		sendmsgEnabled = true;
		$('#log').append("Kapcsolódott!<br/>");
	});
	
	socket.on('agv_get_xy_resp', function (agv_get_xy_resp) {
		//console.log(agv_get_xy_resp);
		$('#log').append(++msgreceived + ". <b>agv_get_xy_resp</b>.header.session_id: " + agv_get_xy_resp.header.session_id + " <br/>" + 
				" X: " + agv_get_xy_resp.data.x +
				", Y: " + agv_get_xy_resp.data.y + 
				", Phi: " + agv_get_xy_resp.data.phi + "<br/>");
	});
	
	socket.on('agv_get_status_resp', function (agv_get_status_resp) {
		//console.log(agv_get_status_resp);
		$('#log').append(++msgreceived + ". <b>agv_get_status_resp</b>.header.session_id: " + agv_get_status_resp.header.session_id + " <br/>" + 
				" Uptime: " + agv_get_status_resp.data.uptime +
				" X: " + agv_get_status_resp.data.x +
				", Y: " + agv_get_status_resp.data.y + 
				", Phi: " + agv_get_status_resp.data.phi + 
				", Max Speed: " + agv_get_status_resp.data.max_speed + "<br/>");
	});
	
	var setIntervalId = false;
	var setTimeoutId = false;

	function startInterval() {
		
		var interval = $('#interval').val();
		var timeout = $('#timeout').val();
		
		setIntervalId = setInterval(function() {
			var agvGetStatusReq = new agv_get_status_req();
			agvGetStatusReq.header.source = source;
			agvGetStatusReq.header.destination = destination;
			agvGetStatusReq.header.session_id = "" + Math.floor(Math.random()*65535);
			sendReq(agvGetStatusReq);
		}, interval);
		
		setTimeoutId = setTimeout(function(){
			stopInterval;
		}, timeout)
	}

	function stopInterval() {
		if (setIntervalId) {
			$('#log').append("TIMER OFF<br/>");
			clearInterval(setIntervalId);
			setIntervalId = false;
		}
	}
	
	function sendGetXYReq() {
		var agvGetXYReq = new agv_get_xy_req();
		agvGetXYReq.header.source = source;
		agvGetXYReq.header.destination = destination;
		agvGetXYReq.header.session_id = "" + Math.floor(Math.random()*65535);
		sendReq(agvGetXYReq);
	}

	function sendCustomReq() {
		var customJsonMsg = $("#custom_msg").val();
		var canSend = false;
		if (customJsonMsg.length > 0) {
			try {
				customJsonMsg = json_parse(customJsonMsg);
				canSend = true;
			} catch (e) {
				alert(e.name + "@" + e.at + ": " + e.message);
			}
		}

		if(canSend && customJsonMsg.hasOwnProperty("header") && customJsonMsg.header.hasOwnProperty("name") && customJsonMsg.header.name.length > 0) {
			customJsonMsg.header.session_id = "" + Math.floor(Math.random()*65535);
			if(!socket.$events.hasOwnProperty(customJsonMsg.header.name)){
				socket.on(customJsonMsg.header.name, function(data){
					$('#log').append(++msgreceived + " Custom üzenet <br/> " +JSON.stringify(data));
				})
			}
			sendReq(customJsonMsg);
		} else {
			if(canSend) alert("Nincs header!");
		}
	}
	
	function sendReq(msg_obj) {
		if (sendmsgEnabled){
			socket.emit('esb message', msg_obj);
			$('#log').append(++msgsent + ". <b>" + msg_obj.header.name + "</b>.header.session_id: " + msg_obj.header.session_id + " <br/>");
			$('#log').append(JSON.stringify(msg_obj));
		} else {
			$('#log').append("Küldeném az " + msg_obj.header.name + "csomagot, de esb még nem kapcsolódott! <br/>");
		}
	}
	</script>
  </head>
  <body>
    <h1>Üzenetek</h1>
    <div id="log" style="width: 800px; height: 500px; border: 1px solid brown; overflow: auto; float: left; margin: 0px 5px 5px 5px;"></div>
    <label for="interval" style="margin-right: 5px;">Interval Delay (ms):</label><input type="text" name="interval" value="1000" id="interval"/><br/>
    <label for="timeout" style="margin-right: 5px;">Clear Interval After (ms):</label><input type="text" name="timeout" value="60000" id="timeout"/><br/>
    <input type="button" name="startInterval" value="Start Interval" id="startInterval" onclick="startInterval();"/><br/>
    <input type="button" name="stopInterval" value="Stop Interval" id="stopInterval" onclick="stopInterval();"/><br/>
    <input type="button" name="sendGetXYReq" value="Send GET_XY_REQ" id="sendGetXYReq" onclick="sendGetXYReq();"/><br/><br/><br/>
    <label for="custom_msg">Custom JSON Message</label>
    <textarea name="custom_msg" id="custom_msg" rows="18" cols="50"></textarea><br/>
    <input type="button" name="sendCustomReq" value="Send Custom REQ" id="sendCustomReq" onclick="sendCustomReq();"/>
  </body>
</html>
